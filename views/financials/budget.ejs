<!DOCTYPE html>
<html lang="en">
<head>
<<<<<<< Updated upstream
  <title>FIN: Budget</title>
=======
  <title>FIN: Home</title>
>>>>>>> Stashed changes
  <%- include('../partials/header.ejs'); %>
</head>
<body>
<div class="budget-container">
  <h2>Budget Overview</h2>

  <% if (typeof budgetSummary !== 'undefined' && budgetSummary) { %>

    <div class="dashboard-row">
      <div class="chart-card">
        <h3>Income Breakdown</h3>
        <canvas id="incomeChart"></canvas>
      </div>

      <div class="chart-card">
        <h3>Expense Breakdown</h3>
        <canvas id="expenseChart"></canvas>
      </div>

      <div class="summary-section">
        <h3>Status: 
          <span class="status <%= budgetSummary.status %>">
            <%= budgetSummary.status %>
          </span></h3>
        <p>Target Expenditure: $<%= budgetSummary.targetExpenditure.toFixed(2) %></p>
        <p>Total Expense: $<%= budgetSummary.totalExpense.toFixed(2) %></p>

        <h4>Budget Breakdown</h4>
        <p>Total Income: $<%= budgetSummary.totalIncome.toFixed(2) %></p>
        <p>Total Expense: $<%= budgetSummary.totalExpense.toFixed(2) %></p>
        <p>FIN SURPLUS (DEFICIT): <strong>$<%= budgetSummary.surplusDeficit.toFixed(2) %></strong></p>
      </div>
    </div>

    <div class="notes-section">
      <h3>Notes</h3>
      <form action="/financials/budget/notes" class="note-form" method="POST">
        <textarea name="notes" placeholder="Write notes..." required><%= typeof notes !== 'undefined' ? notes : '' %></textarea>
        <button type="submit">Save Notes</button>
      </form>
    </div>

    <div class="transactions-section">
      <h3>Recent Transactions</h3>
      <table class="transactionTable">
        <tr>
          <th>Date</th><th>Description</th><th>Amount</th><th>Category</th>
        </tr>
      
        <% if (typeof recentTransactions !== 'undefined') { %>
          <% recentTransactions.forEach(t => { %>
          <tr>
            <td><%= t.date %></td>
            <td><%= t.description %></td>
            <td>
              <% if (t.amount < 0) { %>
                -$<%= Math.abs(Number(t.amount)).toFixed(2) %>
              <% } else { %>
                $<%= Number(t.amount).toFixed(2) %>
              <% } %>
            </td>
            <td><%= t.details?.category || "â€”" %></td>
          </tr>
          <% }) %>
        <% } %>
      </table>
    </div>

  <% } else { %>
    <div style="text-align: center; padding: 50px;">
        <h3>Welcome to your Budget Sheet!</h3>
        <p>It looks like you haven't linked a bank account yet.</p>
        <a href="/financials/add-bank" class="reg-button">Link Bank Account</a>
    </div>
  <% } %>

</div>

<<<<<<< Updated upstream
  <% if (typeof budgetSummary !== 'undefined' && budgetSummary) { %>
    <script>
      // Only define these if data exists to prevent console errors
      const incomeChart = <%- typeof incomeChart !== 'undefined' ? JSON.stringify(incomeChart) : '[]' %>;
      const chartData = <%- typeof recentTransactions !== 'undefined' ? JSON.stringify(recentTransactions) : '[]' %>;
=======
  <div class="notes-section">
    <h3>Notes</h3>
    <form action="/financials/budget" class ="note-form" method="POST">
      
      <% if (locals.csrfToken) { %>
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <% } %>

      <textarea name="notes" placeholder="Write notes..." required><%= notes %></textarea>
      <button type="submit">Save Notes</button>
    </form>
  </div>
>>>>>>> Stashed changes

      // Safe processing for client-side JS
      if(incomeChart.length > 0 && chartData.length > 0) {
          const incomeLabels = incomeChart.map(a => a.type);
          const incomeValues = incomeChart.map(a => a.amount);
          
          const expenseDataFromServer = chartData.filter(t => t.amount < 0);
          const expenseByCategory = {};
          expenseDataFromServer.forEach(t => {
            const cat = t.category || t.details?.category || "Other";
            expenseByCategory[cat] = (expenseByCategory[cat] || 0) + Math.abs(t.amount);
          });
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/budgetCharts.js"></script>
  <% } %>

<<<<<<< Updated upstream
=======
  <script id="payload-income" type="application/json">
    <%- JSON.stringify(incomeChart) %>
  </script>

  <script id="payload-transactions" type="application/json">
    <%- JSON.stringify(recentTransactions) %>
  </script>

  <script>
    // 1. Retrieve and Parse Data safely
    const incomeChart = JSON.parse(document.getElementById('payload-income').textContent);
    const allTransactions = JSON.parse(document.getElementById('payload-transactions').textContent);

    // 2. Process Income Data
    const incomeLabels = incomeChart.map(a => a.type);
    const incomeValues = incomeChart.map(a => a.amount);

    // 3. Process Transaction Data
    const chartData = allTransactions.slice(0, 30);

    const expenseDataFromServer = chartData.filter(t => t.amount < 0);

    const expenseByCategory = {};
    expenseDataFromServer.forEach(t => {
      const cat = t.category || t.details?.category || "Other";
      expenseByCategory[cat] = (expenseByCategory[cat] || 0) + Math.abs(t.amount);
    });

    // Note: These variables (incomeLabels, incomeValues, expenseByCategory) 
    // are now available for 'budgetCharts.js' below.
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/js/budgetCharts.js"></script>

>>>>>>> Stashed changes
  <%- include('../partials/footer.ejs')%>
</body>
</html>