<!DOCTYPE html>
<html lang="en">
<head>
  <title>FIN: Home</title>
  <!-- Header -->
  <%- include('../partials/header.ejs'); %>
</head>
<body>
<div class="budget-container">
  <h2>Budget Overview</h2>

<div class="dashboard-row">
  <div class="chart-card">
    <h3>Income Breakdown</h3>
    <canvas id="incomeChart"></canvas>
  </div>

  <div class="chart-card">
    <h3>Expense Breakdown</h3>
    <canvas id="expenseChart"></canvas>
  </div>

  <div class="summary-section">
    <h3>Status: 
      <span class="status <%= budgetSummary.status %>">
        <%= budgetSummary.status %>
      </span></h3>
    <p>Target Expenditure: <%= budgetSummary.targetExpenditure.toFixed(2) %></p>
    <p>Total Expense: <%= budgetSummary.totalExpense.toFixed(2) %></p>

    <h4>Budget Breakdown</h4>
    <p>Total Income: <%= budgetSummary.totalIncome.toFixed(2) %></p>
    <p>Total Expense: <%= budgetSummary.totalExpense.toFixed(2) %></p>
    <p>FIN SURPLUS (DEFICIT): <strong><%= budgetSummary.surplusDeficit.toFixed(2) %></strong></p>
  </div>
</div>

  <div class="notes-section">
    <h3>Notes</h3>
    <form action="/users/profile/sandbox" method="POST" class="note-form">
      <textarea name="note" placeholder="Write a note..." required></textarea>
      <button type="submit">Save Note</button>
    </form>

    <div class="notes-list">
       
        <p>No notes saved yet.</p>
    </div>
  </div>

  <div class="transactions-section">
    <h3>Recent Transactions</h3>
    <table class="transactionTable">
      <tr>
        <th>Date</th><th>Description</th><th>Amount</th><th>Category</th>
      </tr>
    
      <% recentTransactions.forEach(t => { %>
      <tr>
        <td><%= t.date %></td>
        <td><%= t.description %></td>
        <td>
          <% if (t.amount < 0) { %>
            -$<%= Math.abs(Number(t.amount)).toFixed(2) %>
          <% } else { %>
            $<%= Number(t.amount).toFixed(2) %>
          <% } %>
        </td>
        <td><%= t.details?.category || "â€”" %></td>
      </tr>
      <% }) %>
    </table>
  </div>
</div>

  <!-- Scripts -->
  <script>

    const incomeChart = <%- JSON.stringify(incomeChart) %>;

    const incomeLabels = incomeChart.map(a => a.type);
    const incomeValues = incomeChart.map(a => a.amount);

    const chartData = <%- JSON.stringify(recentTransactions) %>
    .slice(0, 30)

    const expenseDataFromServer = chartData.filter(t => t.amount < 0);

    const expenseByCategory = {};
    expenseDataFromServer.forEach(t => {
      const cat = t.category || t.details?.category || "Other";
      expenseByCategory[cat] = (expenseByCategory[cat] || 0) + Math.abs(t.amount);
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/js/budgetCharts.js"></script>

  <!-- Footer -->
  <%- include('../partials/footer.ejs')%>
</body>
</html>
